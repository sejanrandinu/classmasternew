import{r as u,f as L,w as B,k as b,m as h,n as l,q as o,p as s,a9 as M,v as p,t as c,W as I,Q as T,an as P,a7 as U,U as f}from"./index-BCQP80hx.js";import{Q as D}from"./QBtnToggle-ClMRll_7.js";import{Q as k}from"./QSelect-DCR9V7w2.js";import{Q as R}from"./QForm-DzNt1E0B.js";import{Q as z,a as x}from"./QTable-An4uF7Sr.js";import{Q as O}from"./QTooltip-C3fmHUBD.js";import{Q as F}from"./QChip-BZCpNEhF.js";import{Q as E}from"./QPage-DZO8eRE2.js";import{u as j}from"./use-quasar-C6NPZew5.js";import{s as v}from"./supabase-3Ri18K4t.js";import{_ as H}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./QItem-rw1yFefp.js";import"./QItemLabel-l38w8CTe.js";import"./QMenu-DrHU5L3Z.js";import"./selection-CdExz2ft.js";import"./format-CJebrXOQ.js";import"./QList-CHOuisuT.js";import"./use-fullscreen-BzphbkPZ.js";const G={class:"row q-col-gutter-xl"},J={class:"col-12 col-md-5"},K={class:"text-h5 text-weight-bold q-mb-lg row items-center"},X={class:"bg-grey-1 q-pa-sm rounded-borders"},Y={class:"row q-mt-xl"},Z={class:"text-caption text-grey-6 text-center q-mt-md"},ee={class:"col-12 col-md-7"},te={class:"row items-center"},se={class:"text-weight-medium"},ae={class:"ellipsis"},le={class:"full-width row flex-center text-grey-5 q-pa-xl"},oe={__name:"MessagingPage",setup(ne){const _=j(),m=u(!1),y=u(!1),w=u([]),S=u([]),Q=u([]),q=u([]),i=u(null),n=u({recipient_type:"Student",method:"WhatsApp",content:""}),$=[{name:"date",align:"left",label:"Date/Time",field:a=>new Date(a.sent_at).toLocaleString()},{name:"recipient",align:"left",label:"Recipient",field:"recipient_name"},{name:"content",align:"left",label:"Message",field:"content"},{name:"status",align:"center",label:"Status",field:"status"}];L(()=>{A(),C()}),B(()=>n.value.recipient_type,()=>{i.value=null});const A=async()=>{const{data:a}=await v.from("students").select("id, name, student_id, contact").eq("status","Active");a&&(w.value=a);const{data:t}=await v.from("classes").select("id, class_name, grade").eq("status","Active");t&&(Q.value=t.map(e=>({label:`${e.class_name} (${e.grade})`,value:e.id,grade:e.grade})))},N=(a,t)=>{t(()=>{const e=a.toLowerCase();S.value=w.value.filter(r=>r.name.toLowerCase().indexOf(e)>-1||r.student_id.toLowerCase().indexOf(e)>-1).map(r=>({label:`${r.name} (${r.contact||"No No."})`,value:r.id,contact:r.contact}))})},C=async()=>{y.value=!0;const{data:a}=await v.from("messages").select("*").order("sent_at",{ascending:!1}).limit(20);a&&(q.value=a.map(t=>({...t,method:"WhatsApp"}))),y.value=!1},W=async()=>{m.value=!0;let a=[],t=i.value.label;if(n.value.recipient_type==="Student")a=[i.value.contact];else{const d=i.value.grade;a=w.value.filter(g=>g.grade===d&&g.contact).map(g=>g.contact),t=`${i.value.label} (${a.length} students)`}const e={recipient_type:n.value.recipient_type,recipient_id:i.value.value,recipient_name:t,content:n.value.content,status:"Sent",metadata:{method:"WhatsApp"}};if(n.value.recipient_type==="Student"){let d=a[0];if(d){d.startsWith("0")&&(d="94"+d.substring(1)),d=d.replace(/\D/g,"");const V=`https://wa.me/${d}?text=${encodeURIComponent(n.value.content)}`;window.open(V,"_blank")}}else{_.notify({type:"warning",message:"Bulk WhatsApp sending is not supported via direct links. Please send to individuals."}),m.value=!1;return}const{error:r}=await v.from("messages").insert([e]);m.value=!1,r?_.notify({type:"negative",message:"History logging failed"}):(_.notify({type:"positive",message:"Message dispatched successfully",icon:"auto_awesome",caption:a.length===1?`Sent to: ${a[0]}`:`Sent to ${a.length} students in class`}),n.value.content="",i.value=null,C())};return(a,t)=>(h(),b(E,{class:"q-pa-lg bg-grey-1"},{default:l(()=>[t[9]||(t[9]=o("div",{class:"row items-center justify-between q-mb-xl"},[o("div",null,[o("h1",{class:"text-h3 text-weight-bolder text-grey-9 q-mb-xs mt-0"},"Messaging Center"),o("div",{class:"text-subtitle1 text-grey-6"},"Send updates, reminders, and announcements to your students.")])],-1)),o("div",G,[o("div",J,[s(M,{flat:"",class:"glass-modern q-pa-xl overflow-hidden"},{default:l(()=>[o("h2",K,[s(c,{name:"send",color:"primary",class:"q-mr-sm"}),t[4]||(t[4]=p(" Compose New Message ",-1))]),s(R,{onSubmit:W,class:"q-gutter-lg"},{default:l(()=>[o("div",X,[s(D,{modelValue:n.value.recipient_type,"onUpdate:modelValue":t[0]||(t[0]=e=>n.value.recipient_type=e),spread:"","no-caps":"",unelevated:"","toggle-color":"primary",color:"white","text-color":"grey-7",options:[{label:"Individual Student",value:"Student",icon:"person"},{label:"Entire Class",value:"Class",icon:"groups"}]},null,8,["modelValue"])]),n.value.recipient_type==="Student"?(h(),b(k,{key:0,filled:"",modelValue:i.value,"onUpdate:modelValue":t[1]||(t[1]=e=>i.value=e),"use-input":"","input-debounce":"300",label:"Search Student",options:S.value,onFilter:N,rules:[e=>!!e||"Required"]},{prepend:l(()=>[s(c,{name:"person_search",color:"primary"})]),_:1},8,["modelValue","options","rules"])):(h(),b(k,{key:1,filled:"",modelValue:i.value,"onUpdate:modelValue":t[2]||(t[2]=e=>i.value=e),options:Q.value,label:"Select Class",rules:[e=>!!e||"Required"]},{prepend:l(()=>[s(c,{name:"class",color:"primary"})]),_:1},8,["modelValue","options","rules"])),s(I,{filled:"",modelValue:n.value.content,"onUpdate:modelValue":t[3]||(t[3]=e=>n.value.content=e),type:"textarea",label:"Message Content",placeholder:"Type your message here...",rows:"6",counter:"",maxlength:"160",rules:[e=>!!e||"Message cannot be empty"]},{hint:l(()=>[...t[5]||(t[5]=[p(" Click to generate WhatsApp direct link ",-1)])]),_:1},8,["modelValue","rules"]),o("div",Y,[s(T,{type:"submit",color:"green-7",label:"Send via WhatsApp",icon:"fa-brands fa-whatsapp",unelevated:"",class:"full-width premium-btn h-50",loading:m.value},null,8,["loading"])]),o("div",Z,[s(c,{name:"info",size:"xs"}),t[6]||(t[6]=p(" Messages will open in WhatsApp. Ensure the recipient's number is correct. ",-1))])]),_:1})]),_:1})]),o("div",ee,[s(M,{flat:"",class:"glass-modern overflow-hidden"},{default:l(()=>[s(P,{class:"q-pa-lg"},{default:l(()=>[...t[7]||(t[7]=[o("div",{class:"text-h6 text-weight-bold"},"Communication Log",-1)])]),_:1}),s(U),s(z,{flat:"",rows:q.value,columns:$,"row-key":"id",loading:y.value,pagination:{rowsPerPage:10}},{"body-cell-recipient":l(e=>[s(x,{props:e},{default:l(()=>[o("div",te,[s(c,{name:e.row.recipient_type==="Student"?"person":"groups",size:"xs",color:"grey-6",class:"q-mr-xs"},null,8,["name"]),o("div",se,f(e.row.recipient_name),1)])]),_:2},1032,["props"])]),"body-cell-content":l(e=>[s(x,{props:e,class:"max-width-text"},{default:l(()=>[o("div",ae,f(e.value),1),s(O,{class:"bg-primary"},{default:l(()=>[p(f(e.value),1)]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-status":l(e=>[s(x,{props:e},{default:l(()=>[s(F,{dense:"",color:"green-1","text-color":"green-8",icon:"fa-brands fa-whatsapp",size:"sm"},{default:l(()=>[p(f(e.row.method),1)]),_:2},1024)]),_:2},1032,["props"])]),"no-data":l(()=>[o("div",le,[s(c,{name:"history",size:"48px",class:"q-mb-md"}),t[8]||(t[8]=o("div",{class:"text-h6 full-width text-center"},"No messages sent yet",-1))])]),_:1},8,["rows","loading"])]),_:1})])])]),_:1}))}},qe=H(oe,[["__scopeId","data-v-ec9ce5fb"]]);export{qe as default};
