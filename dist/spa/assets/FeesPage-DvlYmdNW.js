import{r as i,b as S,f as $,k as I,m as C,n,q as a,p as s,a9 as x,t as p,v as r,W as M,T as A,x as O,V as U,an as V,U as u,Q as k,a7 as j}from"./index-BCQP80hx.js";import{Q as z,a as K}from"./QItem-rw1yFefp.js";import{Q as h}from"./QSelect-DCR9V7w2.js";import{Q as E}from"./QBtnToggle-ClMRll_7.js";import{Q as W}from"./QForm-DzNt1E0B.js";import{Q as Y,a as w}from"./QTable-An4uF7Sr.js";import{Q as G}from"./QBadge-Brhg3mLW.js";import{Q as H}from"./QPage-DZO8eRE2.js";import{u as J}from"./use-quasar-C6NPZew5.js";import{s as v}from"./supabase-3Ri18K4t.js";import{_ as X}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./QChip-BZCpNEhF.js";import"./QItemLabel-l38w8CTe.js";import"./QMenu-DrHU5L3Z.js";import"./selection-CdExz2ft.js";import"./format-CJebrXOQ.js";import"./QList-CHOuisuT.js";import"./use-fullscreen-BzphbkPZ.js";const Z={class:"row q-col-gutter-xl"},ee={class:"col-12 col-md-5"},te={class:"absolute-top-right q-pa-md rotate-12 opacity-10"},ae={class:"text-h5 text-weight-bold q-mb-lg row items-center"},se={class:"row q-col-gutter-md"},le={class:"col-12 col-sm-6"},oe={class:"col-12 col-sm-6"},ne={class:"bg-grey-1 q-pa-md rounded-borders"},de={key:0,class:"q-mt-lg"},ie={class:"text-subtitle2 text-primary q-mb-sm row items-center"},re={class:"q-gutter-y-xs"},ue={class:"row"},me={class:"col-7 text-weight-bold"},ce={class:"row"},pe={class:"col-7 text-weight-bold"},fe={class:"row"},ve={class:"col-7 text-weight-bold text-primary"},_e={class:"row"},ge={class:"col-7 text-weight-bold"},ye={class:"row q-mt-xl"},be={class:"col-12 col-md-7"},xe={class:"text-weight-medium"},he={class:"text-caption text-grey-6"},we={class:"text-weight-bolder text-grey-9"},qe={class:"full-width row flex-center text-grey-5 q-pa-xl"},Qe={__name:"FeesPage",setup(Se){const q=J(),c=i(!1),_=i([]),g=i([]),y=i([]),Q=i([]),m=i(null),f=i(null),o=i({student_id:null,class_id:null,amount:0,month:"",payment_method:"Cash"}),P=S(()=>{const l=[],e=new Date;for(let t=-3;t<7;t++){const d=new Date(e.getFullYear(),e.getMonth()+t,1);l.push(d.toLocaleString("default",{month:"long",year:"numeric"}))}return l}),B=S(()=>{if(!f.value)return[];const l=f.value.grade;return y.value.filter(e=>e.grade===l).map(e=>({label:`${e.class_name} (${e.subject})`,value:e.id,fee:e.fee}))}),N=[{name:"date",align:"left",label:"Date",field:l=>new Date(l.payment_date).toLocaleDateString()},{name:"student",align:"left",label:"Student",field:"student_name"},{name:"class",align:"left",label:"Class",field:"class_name"},{name:"month",align:"center",label:"For Month",field:"month"},{name:"amount",align:"right",label:"Amount",field:"amount",sortable:!0}];$(()=>{D(),b(),o.value.month=new Date().toLocaleString("default",{month:"long",year:"numeric"})});const D=async()=>{const{data:l}=await v.from("students").select("id, name, student_id, grade").eq("status","Active");l&&(_.value=l);const{data:e}=await v.from("classes").select("id, class_name, subject, grade, fee, tutor").eq("status","Active");e&&(y.value=e)},F=(l,e)=>{if(l===""){e(()=>{g.value=_.value.map(t=>({label:`${t.name} (${t.student_id})`,value:t.id,grade:t.grade}))});return}e(()=>{const t=l.toLowerCase();g.value=_.value.filter(d=>d.name.toLowerCase().indexOf(t)>-1||d.student_id.toLowerCase().indexOf(t)>-1).map(d=>({label:`${d.name} (${d.student_id})`,value:d.id,grade:d.grade}))})},T=l=>{l&&(o.value.student_id=l.value,o.value.class_id=null,o.value.amount=0)},L=async l=>{const e=y.value.find(t=>t.id===l);if(e)if(o.value.amount=e.fee,e.tutor){const{data:t}=await v.from("tutors").select("*").eq("name",e.tutor).maybeSingle();m.value=t}else m.value=null},b=async()=>{c.value=!0;const{data:l}=await v.from("payments").select(`
            id, amount, month, payment_date,
            students(name, student_id),
            classes(class_name)
        `).order("payment_date",{ascending:!1}).limit(20);l&&(Q.value=l.map(e=>({id:e.id,amount:e.amount,month:e.month,payment_date:e.payment_date,student_name:e.students.name,student_id_str:e.students.student_id,class_name:e.classes.class_name}))),c.value=!1},R=async()=>{c.value=!0;const l="R-"+Date.now().toString().slice(-8),{error:e}=await v.from("payments").insert([{student_id:o.value.student_id,class_id:o.value.class_id,amount:o.value.amount,month:o.value.month,payment_method:o.value.payment_method,receipt_no:l}]);c.value=!1,e?q.notify({type:"negative",message:`Payment failed: ${e.message}`}):(q.notify({type:"positive",message:"Payment collected successfully!",caption:`Receipt: ${l}`,icon:"verified"}),o.value.amount=0,o.value.class_id=null,b())};return(l,e)=>(C(),I(H,{class:"q-pa-lg bg-grey-1"},{default:n(()=>[e[19]||(e[19]=a("div",{class:"row items-center justify-between q-mb-xl"},[a("div",null,[a("h1",{class:"text-h3 text-weight-bolder text-grey-9 q-mb-xs mt-0"},"Collect Fees"),a("div",{class:"text-subtitle1 text-grey-6"},"Manage student payments and generate digital receipts.")])],-1)),a("div",Z,[a("div",ee,[s(x,{flat:"",class:"glass-modern q-pa-xl overflow-hidden"},{default:n(()=>[a("div",te,[s(p,{name:"payments",size:"120px",color:"primary"})]),a("h2",ae,[s(p,{name:"add_card",color:"primary",class:"q-mr-sm"}),e[5]||(e[5]=r(" New Payment Record ",-1))]),s(W,{onSubmit:R,class:"q-gutter-lg"},{default:n(()=>[s(h,{filled:"",modelValue:f.value,"onUpdate:modelValue":[e[0]||(e[0]=t=>f.value=t),T],"use-input":"","input-debounce":"300",label:"Search Student",options:g.value,onFilter:F,"lazy-rules":"",rules:[t=>!!t||"Please select a student"]},{prepend:n(()=>[s(p,{name:"person_search",color:"primary"})]),"no-option":n(()=>[s(z,null,{default:n(()=>[s(K,{class:"text-grey"},{default:n(()=>[...e[6]||(e[6]=[r("No students found",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue","options","rules"]),s(h,{filled:"",modelValue:o.value.class_id,"onUpdate:modelValue":[e[1]||(e[1]=t=>o.value.class_id=t),L],options:B.value,label:"Select Class","emit-value":"","map-options":"",hint:f.value?"":"Find a student first",rules:[t=>!!t||"Required"]},{prepend:n(()=>[s(p,{name:"school",color:"primary"})]),_:1},8,["modelValue","options","hint","rules"]),a("div",se,[a("div",le,[s(h,{filled:"",modelValue:o.value.month,"onUpdate:modelValue":e[2]||(e[2]=t=>o.value.month=t),options:P.value,label:"For Month",rules:[t=>!!t||"Required"]},null,8,["modelValue","options","rules"])]),a("div",oe,[s(M,{filled:"",modelValue:o.value.amount,"onUpdate:modelValue":e[3]||(e[3]=t=>o.value.amount=t),modelModifiers:{number:!0},label:"Amount (LKR)",type:"number",prefix:"Rs.",class:"text-weight-bolder",rules:[t=>t>0||"Invalid amount"]},null,8,["modelValue","rules"])])]),a("div",ne,[e[7]||(e[7]=a("div",{class:"text-caption text-grey-7 q-mb-sm"},"Payment Method",-1)),s(E,{modelValue:o.value.payment_method,"onUpdate:modelValue":e[4]||(e[4]=t=>o.value.payment_method=t),spread:"","no-caps":"",unelevated:"","toggle-color":"primary",color:"white","text-color":"grey-7",options:[{label:"Cash",value:"Cash"},{label:"Bank Transfer or Deposit",value:"Bank Transfer or Deposit"}]},null,8,["modelValue"])]),s(A,{appear:"","enter-active-class":"animated fadeIn","leave-active-class":"animated fadeOut"},{default:n(()=>[o.value.payment_method==="Bank Transfer or Deposit"&&m.value?(C(),O("div",de,[s(x,{flat:"",bordered:"",class:"bg-blue-50 border-blue"},{default:n(()=>[s(V,{class:"q-pa-md"},{default:n(()=>[a("div",ie,[s(p,{name:"account_balance",class:"q-mr-xs"}),e[8]||(e[8]=r(" Tutor Bank Details ",-1))]),a("div",re,[a("div",ue,[e[9]||(e[9]=a("span",{class:"col-5 text-grey-7"},"Bank:",-1)),e[10]||(e[10]=r()),a("span",me,u(m.value.bank_name||"Not Provided"),1)]),a("div",ce,[e[11]||(e[11]=a("span",{class:"col-5 text-grey-7"},"Acc Name:",-1)),e[12]||(e[12]=r()),a("span",pe,u(m.value.bank_account_name||"Not Provided"),1)]),a("div",fe,[e[13]||(e[13]=a("span",{class:"col-5 text-grey-7"},"Acc No:",-1)),e[14]||(e[14]=r()),a("span",ve,u(m.value.bank_account_number||"Not Provided"),1)]),a("div",_e,[e[15]||(e[15]=a("span",{class:"col-5 text-grey-7"},"Branch:",-1)),e[16]||(e[16]=r()),a("span",ge,u(m.value.bank_branch||"Not Provided"),1)])])]),_:1})]),_:1})])):U("",!0)]),_:1}),a("div",ye,[s(k,{type:"submit",color:"primary",label:"Collect Fee & Sync",icon:"check_circle",unelevated:"",class:"full-width premium-btn h-50",loading:c.value},null,8,["loading"])])]),_:1})]),_:1})]),a("div",be,[s(x,{flat:"",class:"glass-modern overflow-hidden"},{default:n(()=>[s(V,{class:"row items-center justify-between q-pa-lg"},{default:n(()=>[e[17]||(e[17]=a("div",{class:"text-h6 text-weight-bold"},"Recent Collections",-1)),s(k,{flat:"",round:"",icon:"refresh",color:"grey-6",onClick:b})]),_:1}),s(j),s(Y,{flat:"",rows:Q.value,columns:N,"row-key":"id",loading:c.value,pagination:{rowsPerPage:10},class:"payment-history-table"},{"body-cell-student":n(t=>[s(w,{props:t},{default:n(()=>[a("div",xe,u(t.row.student_name),1),a("div",he,u(t.row.student_id_str),1)]),_:2},1032,["props"])]),"body-cell-amount":n(t=>[s(w,{props:t},{default:n(()=>[a("div",we,"LKR "+u(t.value.toLocaleString()),1)]),_:2},1032,["props"])]),"body-cell-month":n(t=>[s(w,{props:t},{default:n(()=>[s(G,{color:"blue-1","text-color":"primary",class:"q-pa-xs px-sm text-weight-bold"},{default:n(()=>[r(u(t.value),1)]),_:2},1024)]),_:2},1032,["props"])]),"no-data":n(()=>[a("div",qe,[s(p,{name:"receipt_long",size:"48px",class:"q-mb-md"}),e[18]||(e[18]=a("div",{class:"text-h6 full-width text-center"},"No transactions yet today",-1))])]),_:1},8,["rows","loading"])]),_:1})])])]),_:1}))}},ze=X(Qe,[["__scopeId","data-v-05afc027"]]);export{ze as default};
