import{r as p,b as $,f as z,k as Q,m as f,n as a,q as l,p as s,x as y,a9 as P,t as g,W as B,Q as _,v,U as b,s as I}from"./index-BCQP80hx.js";import{Q as U}from"./QSelect-DCR9V7w2.js";import{Q as C}from"./QTooltip-C3fmHUBD.js";import{Q as O}from"./QBtnToggle-ClMRll_7.js";import{Q as E,a as w}from"./QTable-An4uF7Sr.js";import{Q as j}from"./QPage-DZO8eRE2.js";import{u as H}from"./use-quasar-C6NPZew5.js";import{s as x}from"./supabase-3Ri18K4t.js";import{_ as M}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./QChip-BZCpNEhF.js";import"./QItem-rw1yFefp.js";import"./QItemLabel-l38w8CTe.js";import"./QMenu-DrHU5L3Z.js";import"./selection-CdExz2ft.js";import"./format-CJebrXOQ.js";import"./QList-CHOuisuT.js";import"./use-fullscreen-BzphbkPZ.js";const R={class:"row q-col-gutter-lg items-end"},F={class:"col-12 col-md-4"},G={class:"col-12 col-md-3"},Y={class:"col-12 col-md-5"},J={class:"row q-gutter-sm justify-end"},K={key:0,class:"flex flex-center q-pa-xl empty-container"},L={class:"text-center"},X={key:1,class:"flex flex-center q-pa-xl empty-container"},Z={class:"text-center"},ee={class:"text-grey-6"},te={key:2,class:"row q-col-gutter-lg"},se={class:"col-12"},ae={class:"text-weight-bold text-primary"},oe={class:"row items-center"},le={class:"text-weight-medium"},ne={key:1,class:"text-grey-4"},re={__name:"AttendancePage",setup(de){const n=H(),i=p(!1),r=p(null),c=p(new Date().toISOString().split("T")[0]),h=p([]),u=p([]),k=p([]),V=[{name:"student_id",align:"left",label:"ID",field:"student_id",sortable:!0},{name:"name",align:"left",label:"Student Name",field:"name",sortable:!0},{name:"status",align:"center",label:"Attendance Status",field:"id"},{name:"notify",align:"center",label:"Notify",field:"id"}],A=$(()=>{const o=k.value.find(e=>e.id===r.value);return o?o.grade:""});z(()=>{N()});const N=async()=>{const{data:o}=await x.from("classes").select("*").eq("status","Active").order("class_name");o&&(k.value=o,h.value=o.map(e=>({label:`${e.class_name} (${e.grade})`,value:e.id})))},q=async()=>{if(!r.value||!c.value)return;i.value=!0;const{data:o,error:e}=await x.from("students").select("*").eq("grade",A.value).eq("status","Active").order("name");if(e){n.notify({type:"negative",message:"Failed to load students"}),i.value=!1;return}const{data:t}=await x.from("attendance").select("*").eq("class_id",r.value).eq("date",c.value);u.value=o.map(d=>{const m=t?.find(W=>W.student_id===d.id);return{...d,attendanceStatus:m?m.status:"Present"}}),i.value=!1},D=async()=>{if(!r.value||!c.value){n.notify({type:"warning",message:"Please select class and date"});return}i.value=!0;const o=u.value.map(t=>({student_id:t.id,class_id:r.value,date:c.value,status:t.attendanceStatus})),{error:e}=await x.from("attendance").upsert(o,{onConflict:"student_id,class_id,date"});i.value=!1,e?(console.error("Save error:",e),n.notify({type:"negative",message:`Save failed: ${e.message}`})):n.notify({type:"positive",message:"Attendance records saved successfully"})},T=()=>{const o=u.value.filter(e=>e.attendanceStatus==="Present"&&e.contact);if(o.length===0){n.notify({type:"warning",message:"No present students with WhatsApp numbers found."});return}n.dialog({title:"Notify All Present",message:`This will attempt to open WhatsApp for ${o.length} students. Your browser may block multiple tabs. Do you want to proceed?`,cancel:!0,persistent:!0,ok:{label:"Start Sending",color:"green"}}).onOk(()=>{o.forEach((e,t)=>{setTimeout(()=>{S(e)},t*1e3)})})},S=o=>{if(!o.contact){n.notify({type:"warning",message:"No WhatsApp number for this student"});return}let e=o.contact;e.startsWith("0")&&(e="94"+e.substring(1)),e=e.replace(/\D/g,"");const t=`Halo ${o.name}, අද පන්තියට පැමිණි බව අපි සටහන් කර ගත්තා. ස්තූතියි!`,d=`https://wa.me/${e}?text=${encodeURIComponent(t)}`,m=window.open(d,"_blank");(!m||m.closed||typeof m.closed>"u")&&n.notify({message:"WhatsApp blocked! Click below to send.",type:"warning",position:"top",timeout:1e4,actions:[{label:"Send Now",color:"white",handler:()=>window.open(d,"_blank")}]})};return(o,e)=>(f(),Q(j,{class:"q-pa-lg bg-grey-1"},{default:a(()=>[e[8]||(e[8]=l("div",{class:"row items-center justify-between q-mb-xl"},[l("div",null,[l("h1",{class:"text-h3 text-weight-bolder text-grey-9 q-mb-xs mt-0"},"Attendance Tracker"),l("div",{class:"text-subtitle1 text-grey-6"},"Mark and monitor student attendance for your classes.")])],-1)),s(P,{flat:"",class:"glass-modern q-pa-lg q-mb-xl"},{default:a(()=>[l("div",R,[l("div",F,[s(U,{filled:"",modelValue:r.value,"onUpdate:modelValue":[e[0]||(e[0]=t=>r.value=t),q],options:h.value,label:"Select Class","emit-value":"","map-options":""},{prepend:a(()=>[s(g,{name:"class",color:"primary"})]),_:1},8,["modelValue","options"])]),l("div",G,[s(B,{filled:"",modelValue:c.value,"onUpdate:modelValue":[e[1]||(e[1]=t=>c.value=t),q],label:"Session Date",type:"date","stack-label":""},{prepend:a(()=>[s(g,{name:"event",color:"primary"})]),_:1},8,["modelValue"])]),l("div",Y,[l("div",J,[s(_,{color:"green-7",outline:"",icon:"fa-brands fa-whatsapp",label:"Notify All Present","no-caps":"",class:"rounded-borders",disable:u.value.length===0,onClick:T},{default:a(()=>[s(C,null,{default:a(()=>[...e[2]||(e[2]=[v("Send WhatsApp to all present students",-1)])]),_:1})]),_:1},8,["disable"]),s(_,{color:"secondary",outline:"",icon:"history",label:"View History",to:"/dashboard/attendance-history","no-caps":"",class:"rounded-borders"}),s(_,{color:"primary",icon:"check_circle",label:"Save Attendance",unelevated:"","no-caps":"",class:"premium-btn q-px-lg",loading:i.value,onClick:D},null,8,["loading"])])])])]),_:1}),r.value?u.value.length===0&&!i.value?(f(),y("div",X,[l("div",Z,[s(g,{name:"group_off",size:"64px",color:"grey-4"}),e[4]||(e[4]=l("div",{class:"text-h5 text-grey-5 q-mt-md"},"No students found for this grade",-1)),l("p",ee,"Only students in "+b(A.value)+" will appear here.",1)])])):(f(),y("div",te,[l("div",se,[s(P,{flat:"",class:"glass-modern overflow-hidden"},{default:a(()=>[s(E,{flat:"",rows:u.value,columns:V,"row-key":"id",pagination:{rowsPerPage:0},"hide-bottom":""},{"body-cell-status":a(t=>[s(w,{props:t},{default:a(()=>[s(O,{modelValue:t.row.attendanceStatus,"onUpdate:modelValue":d=>t.row.attendanceStatus=d,spread:"","no-caps":"",unelevated:"","toggle-color":"primary",color:"grey-2","text-color":"grey-7",size:"sm",class:"attendance-toggle",options:[{label:"Present",value:"Present",slot:"present"},{label:"Absent",value:"Absent",slot:"absent"}]},{present:a(()=>[s(g,{name:"check",size:"16px",class:"q-mr-xs"}),e[5]||(e[5]=v(" Present ",-1))]),absent:a(()=>[s(g,{name:"close",size:"16px",class:"q-mr-xs"}),e[6]||(e[6]=v(" Absent ",-1))]),_:1},8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["props"])]),"body-cell-student_id":a(t=>[s(w,{props:t},{default:a(()=>[l("span",ae,b(t.value),1)]),_:2},1032,["props"])]),"body-cell-name":a(t=>[s(w,{props:t},{default:a(()=>[l("div",oe,[s(I,{size:"28px",color:"blue-1","text-color":"primary",class:"q-mr-sm"},{default:a(()=>[v(b(t.row.name.charAt(0)),1)]),_:2},1024),l("span",le,b(t.row.name),1)])]),_:2},1032,["props"])]),"body-cell-notify":a(t=>[s(w,{props:t,class:"text-center"},{default:a(()=>[t.row.attendanceStatus==="Present"?(f(),Q(_,{key:0,flat:"",round:"",color:"green-7",icon:"fa-brands fa-whatsapp",size:"sm",onClick:d=>S(t.row)},{default:a(()=>[s(C,null,{default:a(()=>[...e[7]||(e[7]=[v("Notify via WhatsApp",-1)])]),_:1})]),_:1},8,["onClick"])):(f(),y("div",ne,"-"))]),_:2},1032,["props"])]),_:1},8,["rows"])]),_:1})])])):(f(),y("div",K,[l("div",L,[s(g,{name:"arrow_upward",size:"64px",color:"grey-4"}),e[3]||(e[3]=l("div",{class:"text-h5 text-grey-5 q-mt-md"},"Please select a class to begin",-1))])]))]),_:1}))}},Se=M(re,[["__scopeId","data-v-512e6485"]]);export{Se as default};
